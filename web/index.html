<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SayHi DApp - åŒºå—é“¾æ‰“æ‹›å‘¼åº”ç”¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .wallet-section {
        text-align: center;
        margin-bottom: 30px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .input-group {
        margin: 20px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #4a5568;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
      }

      .status.success {
        background-color: #c6f6d5;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      .status.error {
        background-color: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
      }

      .status.info {
        background-color: #bee3f8;
        color: #2a4365;
        border: 1px solid #63b3ed;
      }

      .hidden {
        display: none;
      }

      .message-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }

      .message-header {
        font-weight: bold;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .message-content {
        color: #2d3748;
        margin-bottom: 8px;
      }

      .message-meta {
        font-size: 12px;
        color: #718096;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .btn.connected {
        background: linear-gradient(45deg, #48bb78, #38a169);
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin: 20px 0;
      }

      .stat-item {
        flex: 1;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #718096;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸŒŸ SayHi DApp</h1>

      <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
      <div class="card">
        <div class="wallet-section">
          <div id="walletStatus" class="status info">æ£€æŸ¥MetaMaskçŠ¶æ€ä¸­...</div>
          <button id="connectWallet" class="btn">è¿æ¥ MetaMask</button>
          <button id="debugBtn" class="btn" style="background: #718096">è°ƒè¯•ä¿¡æ¯</button>
          <div id="accountInfo" class="hidden">
            <p><strong>å½“å‰è´¦æˆ·:</strong> <span id="currentAccount"></span></p>
            <p><strong>ä½™é¢:</strong> <span id="accountBalance"></span> ETH</p>
            <p><strong>ç½‘ç»œ:</strong> <span id="networkInfo"></span></p>
          </div>
          <div id="debugInfo" class="debug-info hidden">
            <h4>è°ƒè¯•ä¿¡æ¯:</h4>
            <div id="debugLog">ç­‰å¾…è°ƒè¯•ä¿¡æ¯...</div>
          </div>
        </div>
      </div>

      <!-- åˆçº¦ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="card">
        <h3>ğŸ“Š åˆçº¦ç»Ÿè®¡</h3>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number" id="totalMessages">0</div>
            <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="contractBalance">0</div>
            <div class="stat-label">åˆçº¦ä½™é¢ (ETH)</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="myMessages">0</div>
            <div class="stat-label">æˆ‘çš„æ¶ˆæ¯æ•°</div>
          </div>
        </div>
        <button id="refreshStats" class="btn">åˆ·æ–°ç»Ÿè®¡</button>
      </div>

      <!-- å‘é€æ¶ˆæ¯åŒºåŸŸ -->
      <div class="card">
        <h3>ğŸ’¬ å‘é€æ¶ˆæ¯</h3>
        <div class="input-group">
          <label for="messageInput">æ¶ˆæ¯å†…å®¹:</label>
          <textarea id="messageInput" rows="3" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..."></textarea>
        </div>
        <div class="input-group">
          <label for="ethAmount">è½¬è´¦é‡‘é¢ (ETH, å¯é€‰):</label>
          <input type="number" id="ethAmount" step="0.001" min="0" placeholder="0.01" />
        </div>
        <button id="sendMessage" class="btn">å‘é€æ¶ˆæ¯ + è½¬è´¦</button>
        <!-- <button id="callSayHi" class="btn" style="background: #38a169">ç›´æ¥è°ƒç”¨ sayHi</button>
        <button id="testContract" class="btn" style="background: #ed8936">æµ‹è¯•åˆçº¦è¿æ¥</button>
        <button id="checkDeployment" class="btn" style="background: #9f7aea">æ£€æŸ¥åˆçº¦éƒ¨ç½²</button> -->
        <div id="sendStatus"></div>
      </div>

      <!-- æŸ¥è¯¢æ¶ˆæ¯åŒºåŸŸ -->
      <!-- <div class="card">
        <h3>ğŸ” æŸ¥è¯¢æ¶ˆæ¯</h3>
        <button id="getLatestMessage" class="btn">è·å–æœ€æ–°æ¶ˆæ¯</button>
        <div class="input-group">
          <label for="messageIndex">æ¶ˆæ¯ç´¢å¼•:</label>
          <input type="number" id="messageIndex" min="0" placeholder="0" />
          <button id="getMessageByIndex" class="btn">æŒ‰ç´¢å¼•æŸ¥è¯¢</button>
        </div>
        <div id="queryStatus"></div>
      </div> -->

      <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
      <div class="card">
        <h3>ğŸ“ æ¶ˆæ¯åˆ—è¡¨</h3>
        <button id="loadAllMessages" class="btn">åŠ è½½æ‰€æœ‰æ¶ˆæ¯</button>
        <div id="messagesList"></div>
      </div>
    </div>

    <script>
      // åˆçº¦é…ç½®
      const CONTRACT_ADDRESS = '0x61aa7C18cBB9D3d9A7FcB017BeC2D05B2255F2fa';
      let CONTRACT_ABI = null; // å°†ä»JSONæ–‡ä»¶åŠ è½½

      // å…¨å±€å˜é‡
      let provider;
      let signer;
      let contract;
      let userAccount;

      // åŠ è½½åˆçº¦ABI
      async function loadContractABI() {
        try {
          console.log('æ­£åœ¨åŠ è½½åˆçº¦ABI...');
          const response = await fetch('./FirstContract.json');

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contractJson = await response.json();
          CONTRACT_ABI = contractJson.abi;

          console.log('ABIåŠ è½½æˆåŠŸ:', CONTRACT_ABI);
          return true;
        } catch (error) {
          console.error('åŠ è½½ABIå¤±è´¥:', error);

          // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ABI
          console.log('ä½¿ç”¨å¤‡ç”¨ABI...');
          CONTRACT_ABI = [
            {
              inputs: [{ internalType: 'string', name: '_message', type: 'string' }],
              name: 'sayHi',
              outputs: [],
              stateMutability: 'payable',
              type: 'function',
            },
            {
              inputs: [{ internalType: 'uint256', name: '_index', type: 'uint256' }],
              name: 'getMessage',
              outputs: [
                { internalType: 'address', name: 'sender', type: 'address' },
                { internalType: 'string', name: 'content', type: 'string' },
                { internalType: 'uint256', name: 'timestamp', type: 'uint256' },
                { internalType: 'uint256', name: 'amount', type: 'uint256' },
              ],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getLatestMessage',
              outputs: [
                { internalType: 'address', name: 'sender', type: 'address' },
                { internalType: 'string', name: 'content', type: 'string' },
                { internalType: 'uint256', name: 'timestamp', type: 'uint256' },
                { internalType: 'uint256', name: 'amount', type: 'uint256' },
              ],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getTotalMessages',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [{ internalType: 'address', name: '_sender', type: 'address' }],
              name: 'getSenderMessageCount',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getContractBalance',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
          ];

          showStatus('walletStatus', 'info', 'ABIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ABIã€‚è¯·ç¡®ä¿FirstContract.jsonæ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚');
          return false;
        }
      }

      // åˆå§‹åŒ–
      $(document).ready(async function () {
        console.log('é¡µé¢åŠ è½½å®Œæˆ');

        // é¦–å…ˆåŠ è½½ABI
        const abiLoaded = await loadContractABI();

        if (abiLoaded) {
          showStatus('walletStatus', 'success', 'ABIåŠ è½½æˆåŠŸï¼Œè¯·è¿æ¥MetaMaské’±åŒ…');
        }

        checkMetaMaskInstallation();
        setupEventListeners();
        checkExistingConnection();
      });

      // æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥
      async function checkExistingConnection() {
        if (typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              console.log('æ£€æµ‹åˆ°å·²è¿æ¥çš„è´¦æˆ·:', accounts[0]);
              // è‡ªåŠ¨è¿æ¥
              await connectWallet();
            }
          } catch (error) {
            console.log('æ£€æŸ¥ç°æœ‰è¿æ¥æ—¶å‡ºé”™:', error);
          }
        }
      }

      // æ£€æŸ¥MetaMaskæ˜¯å¦å®‰è£…
      function checkMetaMaskInstallation() {
        console.log('æ£€æŸ¥MetaMaskå®‰è£…çŠ¶æ€...');
        if (typeof window.ethereum !== 'undefined') {
          console.log('MetaMaskå·²å®‰è£…');
          provider = new ethers.BrowserProvider(window.ethereum);
          showStatus('walletStatus', 'info', 'è¯·è¿æ¥æ‚¨çš„MetaMaské’±åŒ…');
        } else {
          console.log('MetaMaskæœªå®‰è£…');
          showStatus('walletStatus', 'error', 'è¯·å®‰è£… MetaMask é’±åŒ…! è®¿é—®: https://metamask.io');
          $('#connectWallet').prop('disabled', true);
        }
      }

      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        $('#connectWallet').click(connectWallet);
        $('#debugBtn').click(toggleDebugInfo);
        $('#sendMessage').click(sendMessage);
        // $('#callSayHi').click(callSayHiFunction);
        $('#testContract').click(testContract);
        $('#checkDeployment').click(checkContractDeployment);
        $('#getLatestMessage').click(getLatestMessage);
        $('#getMessageByIndex').click(getMessageByIndex);
        $('#refreshStats').click(refreshStats);
        $('#loadAllMessages').click(loadAllMessages);

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', handleAccountsChanged);
          window.ethereum.on('chainChanged', handleChainChanged);
        }
      }

      // æµ‹è¯•åˆçº¦è¿æ¥
      async function testContract() {
        if (!contract) {
          showStatus('sendStatus', 'error', 'è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        try {
          showStatus('sendStatus', 'info', 'æ­£åœ¨æµ‹è¯•åˆçº¦è¿æ¥...');

          // é¦–å…ˆæ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦æœ‰ä»£ç 
          const code = await provider.getCode(CONTRACT_ADDRESS);
          console.log('åˆçº¦ä»£ç é•¿åº¦:', code.length);

          if (code === '0x' || code.length <= 2) {
            showStatus(
              'sendStatus',
              'error',
              `åˆçº¦åœ°å€ ${CONTRACT_ADDRESS} ä¸Šæ²¡æœ‰éƒ¨ç½²ä»£ç ï¼<br>
                        è¯·æ£€æŸ¥ï¼š<br>
                        1. åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®<br>
                        2. æ˜¯å¦è¿æ¥åˆ°æ­£ç¡®çš„ç½‘ç»œ<br>
                        3. åˆçº¦æ˜¯å¦å·²æ­£ç¡®éƒ¨ç½²`
            );
            return;
          }

          console.log('åˆçº¦ä»£ç å­˜åœ¨ï¼Œé•¿åº¦:', code.length);

          // æµ‹è¯•åŸºæœ¬çš„viewå‡½æ•°
          console.log('æµ‹è¯• getTotalMessages...');
          const totalMessages = await contract.getTotalMessages();
          console.log('æ€»æ¶ˆæ¯æ•°:', totalMessages.toString());

          console.log('æµ‹è¯• getContractBalance...');
          const contractBalance = await contract.getContractBalance();
          console.log('åˆçº¦ä½™é¢:', ethers.formatEther(contractBalance));

          showStatus(
            'sendStatus',
            'success',
            `åˆçº¦è¿æ¥æˆåŠŸï¼<br>
                    åˆçº¦ä»£ç é•¿åº¦: ${code.length} bytes<br>
                    æ€»æ¶ˆæ¯æ•°: ${totalMessages.toString()}<br>
                    åˆçº¦ä½™é¢: ${ethers.formatEther(contractBalance)} ETH`
          );
        } catch (error) {
          console.error('åˆçº¦æµ‹è¯•å¤±è´¥:', error);

          let errorMessage = 'åˆçº¦æµ‹è¯•å¤±è´¥: ';

          if (error.code === 'BAD_DATA') {
            errorMessage += 'æ•°æ®è§£ç å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š<br>1. åˆçº¦ABIä¸åŒ¹é…<br>2. å‡½æ•°åç§°é”™è¯¯<br>3. åˆçº¦ç‰ˆæœ¬ä¸ä¸€è‡´';
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage += 'åˆçº¦è°ƒç”¨å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯å‡½æ•°ä¸å­˜åœ¨æˆ–å‚æ•°é”™è¯¯';
          } else {
            errorMessage += error.message;
          }

          showStatus('sendStatus', 'error', errorMessage);
        }
      }

      // æ–°å¢ï¼šæ£€æŸ¥åˆçº¦éƒ¨ç½²çŠ¶æ€
      async function checkContractDeployment() {
        if (!provider) {
          showStatus('sendStatus', 'error', 'è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        try {
          showStatus('sendStatus', 'info', 'æ­£åœ¨æ£€æŸ¥åˆçº¦éƒ¨ç½²çŠ¶æ€...');

          const code = await provider.getCode(CONTRACT_ADDRESS);
          const network = await provider.getNetwork();

          let status = `
                    <strong>ç½‘ç»œä¿¡æ¯:</strong><br>
                    - åç§°: ${network.name}<br>
                    - Chain ID: ${network.chainId}<br>
                    - åˆçº¦åœ°å€: ${CONTRACT_ADDRESS}<br>
                    - åˆçº¦ä»£ç : ${code === '0x' ? 'âŒ æœªéƒ¨ç½²' : 'âœ… å·²éƒ¨ç½² (' + code.length + ' bytes)'}<br>
                `;

          if (code === '0x') {
            status += `<br><strong>âŒ åˆçº¦æœªéƒ¨ç½²åˆ°å½“å‰ç½‘ç»œï¼</strong><br>
                    è¯·æ£€æŸ¥ï¼š<br>
                    1. åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®<br>
                    2. æ˜¯å¦è¿æ¥åˆ°æ­£ç¡®çš„ç½‘ç»œ<br>
                    3. åˆçº¦æ˜¯å¦å·²åœ¨å½“å‰ç½‘ç»œéƒ¨ç½²`;
            showStatus('sendStatus', 'error', status);
          } else {
            status += `<br><strong>âœ… åˆçº¦å·²æ­£ç¡®éƒ¨ç½²</strong>`;
            showStatus('sendStatus', 'success', status);
          }
        } catch (error) {
          console.error('æ£€æŸ¥åˆçº¦éƒ¨ç½²å¤±è´¥:', error);
          showStatus('sendStatus', 'error', 'æ£€æŸ¥å¤±è´¥: ' + error.message);
        }
      }

      // åˆ‡æ¢è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
      async function toggleDebugInfo() {
        const debugDiv = $('#debugInfo');
        debugDiv.toggleClass('hidden');

        if (!debugDiv.hasClass('hidden')) {
          await updateDebugInfo();
        }
      }

      // æ›´æ–°è°ƒè¯•ä¿¡æ¯
      async function updateDebugInfo() {
        const debugLog = $('#debugLog');
        let info = `
                <strong>æ—¶é—´:</strong> ${new Date().toLocaleString()}<br>
                <strong>ABIçŠ¶æ€:</strong> ${CONTRACT_ABI ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}<br>
                <strong>MetaMaskçŠ¶æ€:</strong> ${typeof window.ethereum !== 'undefined' ? 'å·²å®‰è£…' : 'æœªå®‰è£…'}<br>
                <strong>Provider:</strong> ${provider ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}<br>
                <strong>Signer:</strong> ${signer ? 'å·²è·å–' : 'æœªè·å–'}<br>
                <strong>Contract:</strong> ${contract ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}<br>
                <strong>ç”¨æˆ·è´¦æˆ·:</strong> ${userAccount || 'æœªè¿æ¥'}<br>
                <strong>åˆçº¦åœ°å€:</strong> ${CONTRACT_ADDRESS}<br>
            `;

        if (window.ethereum) {
          info += `<strong>Ethereumå¯¹è±¡:</strong> å­˜åœ¨<br>`;
          info += `<strong>æ˜¯å¦ä¸ºMetaMask:</strong> ${window.ethereum.isMetaMask ? 'æ˜¯' : 'å¦'}<br>`;
        }

        if (provider) {
          try {
            const network = await provider.getNetwork();
            info += `<strong>å½“å‰ç½‘ç»œ:</strong> ${network.name} (Chain ID: ${network.chainId})<br>`;

            // æ£€æŸ¥åˆçº¦ä»£ç 
            const code = await provider.getCode(CONTRACT_ADDRESS);
            info += `<strong>åˆçº¦ä»£ç :</strong> ${code === '0x' ? 'âŒ æœªéƒ¨ç½²' : 'âœ… å·²éƒ¨ç½² (' + code.length + ' bytes)'}<br>`;
          } catch (e) {
            info += `<strong>ç½‘ç»œè·å–å¤±è´¥:</strong> ${e.message}<br>`;
          }
        }

        if (contract && provider) {
          try {
            // æ£€æŸ¥åˆçº¦ä»£ç æ˜¯å¦å­˜åœ¨
            const code = await provider.getCode(CONTRACT_ADDRESS);
            if (code !== '0x') {
              // æµ‹è¯•åˆçº¦è¿æ¥
              const totalMessages = await contract.getTotalMessages();
              info += `<strong>åˆçº¦æµ‹è¯•:</strong> âœ… æˆåŠŸ (æ€»æ¶ˆæ¯æ•°: ${totalMessages.toString()})<br>`;
            } else {
              info += `<strong>åˆçº¦æµ‹è¯•:</strong> âŒ åˆçº¦æœªéƒ¨ç½²<br>`;
            }
          } catch (e) {
            info += `<strong>åˆçº¦æµ‹è¯•å¤±è´¥:</strong> ${e.message}<br>`;
          }
        }

        if (CONTRACT_ABI) {
          info += `<strong>ABIå‡½æ•°æ•°é‡:</strong> ${CONTRACT_ABI.filter((item) => item.type === 'function').length}<br>`;
        }

        debugLog.html(info);
      }

      // è¿æ¥é’±åŒ…
      async function connectWallet() {
        try {
          console.log('å¼€å§‹è¿æ¥é’±åŒ…...');
          showStatus('walletStatus', 'info', 'æ­£åœ¨è¿æ¥é’±åŒ…...');

          // æ£€æŸ¥ABIæ˜¯å¦å·²åŠ è½½
          if (!CONTRACT_ABI) {
            showStatus('walletStatus', 'error', 'åˆçº¦ABIæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }

          // æ£€æŸ¥MetaMaskæ˜¯å¦å¯ç”¨
          if (typeof window.ethereum === 'undefined') {
            throw new Error('MetaMaskæœªå®‰è£…');
          }

          // è¯·æ±‚è¿æ¥è´¦æˆ·
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          });

          console.log('è·å–åˆ°çš„è´¦æˆ·:', accounts);

          if (accounts.length === 0) {
            throw new Error('æœªè·å–åˆ°è´¦æˆ·');
          }

          userAccount = accounts[0];
          console.log('å½“å‰ç”¨æˆ·è´¦æˆ·:', userAccount);

          // é‡æ–°åˆå§‹åŒ–providerå’Œsigner
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          console.log('åˆçº¦åˆå§‹åŒ–å®Œæˆ');

          // è·å–å¹¶æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
          const network = await provider.getNetwork();
          $('#networkInfo').text(`${network.name} (Chain ID: ${network.chainId})`);

          // æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
          $('#currentAccount').text(userAccount);
          const balance = await provider.getBalance(userAccount);
          $('#accountBalance').text(parseFloat(ethers.formatEther(balance)).toFixed(4));

          // æ›´æ–°UI
          $('#accountInfo').removeClass('hidden');
          $('#connectWallet').text('å·²è¿æ¥').prop('disabled', true).addClass('connected');
          showStatus('walletStatus', 'success', 'é’±åŒ…è¿æ¥æˆåŠŸ!');

          console.log('UIæ›´æ–°å®Œæˆ');

          // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
          await refreshStats();
        } catch (error) {
          console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
          showStatus('walletStatus', 'error', 'è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);

          // é‡ç½®UIçŠ¶æ€
          $('#accountInfo').addClass('hidden');
          $('#connectWallet').text('è¿æ¥ MetaMask').prop('disabled', false);
        }
      }

      // å‘é€æ¶ˆæ¯
      async function sendMessage() {
        if (!contract) {
          showStatus('sendStatus', 'error', 'è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        const message = $('#messageInput').val().trim();
        if (!message) {
          showStatus('sendStatus', 'error', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
          return;
        }

        try {
          showStatus('sendStatus', 'info', 'æ­£åœ¨å‘é€æ¶ˆæ¯...');
          console.log('å‡†å¤‡å‘é€æ¶ˆæ¯:', message);

          const ethAmount = $('#ethAmount').val() || '0';
          console.log('è½¬è´¦é‡‘é¢:', ethAmount, 'ETH');

          // ä¼°ç®—gasè´¹ç”¨
          let gasEstimate;
          try {
            if (parseFloat(ethAmount) > 0) {
              gasEstimate = await contract.sayHi.estimateGas(message, {
                value: ethers.parseEther(ethAmount),
              });
            } else {
              gasEstimate = await contract.sayHi.estimateGas(message);
            }
            console.log('ä¼°ç®—gasè´¹ç”¨:', gasEstimate.toString());
          } catch (gasError) {
            console.error('Gasä¼°ç®—å¤±è´¥:', gasError);
            showStatus('sendStatus', 'error', 'Gasä¼°ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåˆçº¦åœ°å€');
            return;
          }

          // å‡†å¤‡äº¤æ˜“é€‰é¡¹
          const options = {
            gasLimit: (gasEstimate * 120n) / 100n, // å¢åŠ 20%çš„gasé™åˆ¶
          };

          if (parseFloat(ethAmount) > 0) {
            options.value = ethers.parseEther(ethAmount);
          }

          console.log('äº¤æ˜“é€‰é¡¹:', options);

          // å‘é€äº¤æ˜“
          const tx = await contract.sayHi(message, options);
          console.log('äº¤æ˜“å·²æäº¤:', tx.hash);
          showStatus('sendStatus', 'info', `äº¤æ˜“å·²æäº¤ï¼Œæ­£åœ¨ç­‰å¾…ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

          // ç­‰å¾…äº¤æ˜“ç¡®è®¤
          const receipt = await tx.wait();
          console.log('äº¤æ˜“å·²ç¡®è®¤:', receipt);

          if (receipt.status === 1) {
            showStatus('sendStatus', 'success', `æ¶ˆæ¯å‘é€æˆåŠŸï¼<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}<br>Gasä½¿ç”¨: ${receipt.gasUsed.toString()}`);

            // æ¸…ç©ºè¾“å…¥æ¡†
            $('#messageInput').val('');
            $('#ethAmount').val('');

            // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
            await refreshStats();
          } else {
            showStatus('sendStatus', 'error', 'äº¤æ˜“å¤±è´¥');
          }
        } catch (error) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);

          let errorMessage = 'å‘é€å¤±è´¥: ';
          if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage += 'ä½™é¢ä¸è¶³';
          } else if (error.code === 'USER_REJECTED') {
            errorMessage += 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
          } else if (error.message.includes('execution reverted')) {
            errorMessage += 'åˆçº¦æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‚æ•°';
          } else {
            errorMessage += error.message;
          }

          showStatus('sendStatus', 'error', errorMessage);
        }
      }

      // è·å–æœ€æ–°æ¶ˆæ¯
      async function getLatestMessage() {
        if (!contract) {
          showStatus('queryStatus', 'error', 'è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        try {
          showStatus('queryStatus', 'info', 'æ­£åœ¨æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯...');

          const result = await contract.getLatestMessage();
          displayMessage(result, 'æœ€æ–°æ¶ˆæ¯');
          showStatus('queryStatus', 'success', 'æŸ¥è¯¢æˆåŠŸ!');
        } catch (error) {
          console.error('æŸ¥è¯¢å¤±è´¥:', error);
          showStatus('queryStatus', 'error', 'æŸ¥è¯¢å¤±è´¥: ' + error.message);
        }
      }

      // æŒ‰ç´¢å¼•è·å–æ¶ˆæ¯
      async function getMessageByIndex() {
        if (!contract) {
          showStatus('queryStatus', 'error', 'è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        const index = $('#messageIndex').val();
        if (index === '') {
          showStatus('queryStatus', 'error', 'è¯·è¾“å…¥æ¶ˆæ¯ç´¢å¼•');
          return;
        }

        try {
          showStatus('queryStatus', 'info', 'æ­£åœ¨æŸ¥è¯¢æ¶ˆæ¯...');

          const result = await contract.getMessage(index);
          displayMessage(result, `æ¶ˆæ¯ #${index}`);
          showStatus('queryStatus', 'success', 'æŸ¥è¯¢æˆåŠŸ!');
        } catch (error) {
          console.error('æŸ¥è¯¢å¤±è´¥:', error);
          showStatus('queryStatus', 'error', 'æŸ¥è¯¢å¤±è´¥: ' + error.message);
        }
      }

      // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
      async function refreshStats() {
        if (!contract) return;

        try {
          const totalMessages = await contract.getTotalMessages();
          $('#totalMessages').text(totalMessages.toString());

          const contractBalance = await contract.getContractBalance();
          $('#contractBalance').text(ethers.formatEther(contractBalance));

          if (userAccount) {
            const myMessages = await contract.getSenderMessageCount(userAccount);
            $('#myMessages').text(myMessages.toString());
          }
        } catch (error) {
          console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', error);
        }
      }

      // åŠ è½½æ‰€æœ‰æ¶ˆæ¯
      async function loadAllMessages() {
        if (!contract) {
          alert('è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }

        try {
          const totalMessages = await contract.getTotalMessages();
          console.log('æ€»æ¶ˆæ¯æ•°:', totalMessages.toString());
          const total = parseInt(totalMessages.toString());

          if (total === 0) {
            $('#messagesList').html('<p>æš‚æ— æ¶ˆæ¯</p>');
            return;
          }

          $('#messagesList').html('<p>æ­£åœ¨åŠ è½½æ¶ˆæ¯...</p>');
          let messagesHtml = '';

          // å€’åºæ˜¾ç¤ºæ¶ˆæ¯ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
          for (let i = total - 1; i >= 0; i--) {
            try {
              const result = await contract.getMessage(i);
              messagesHtml += formatMessageHtml(result, i);
            } catch (error) {
              console.error(`è·å–æ¶ˆæ¯ ${i} å¤±è´¥:`, error);
            }
          }

          $('#messagesList').html(messagesHtml || '<p>åŠ è½½æ¶ˆæ¯å¤±è´¥</p>');
        } catch (error) {
          console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
          $('#messagesList').html('<p>åŠ è½½æ¶ˆæ¯å¤±è´¥: ' + error.message + '</p>');
        }
      }

      // æ˜¾ç¤ºå•ä¸ªæ¶ˆæ¯
      function displayMessage(result, title) {
        const messageHtml = `
                <div class="message-item">
                    <div class="message-header">${title}</div>
                    <div class="message-content">"${result[1]}"</div>
                    <div class="message-meta">
                        å‘é€è€…: ${result[0]}<br>
                        è½¬è´¦é‡‘é¢: ${ethers.formatEther(result[3])} ETH<br>
                        æ—¶é—´: ${new Date(Number(result[2]) * 1000).toLocaleString()}
                    </div>
                </div>
            `;
        $('#queryStatus').after(messageHtml);
      }

      // æ ¼å¼åŒ–æ¶ˆæ¯HTML
      function formatMessageHtml(result, index) {
        return `
                <div class="message-item">
                    <div class="message-header">æ¶ˆæ¯ #${index}</div>
                    <div class="message-content">"${result[1]}"</div>
                    <div class="message-meta">
                        å‘é€è€…: ${result[0]}<br>
                        è½¬è´¦é‡‘é¢: ${ethers.formatEther(result[3])} ETH<br>
                        æ—¶é—´: ${new Date(Number(result[2]) * 1000).toLocaleString()}
                    </div>
                </div>
            `;
      }

      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      function showStatus(elementId, type, message) {
        $(`#${elementId}`).removeClass('success error info').addClass(type).text(message);
      }

      // å¤„ç†è´¦æˆ·å˜åŒ–
      function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
          // ç”¨æˆ·æ–­å¼€äº†è¿æ¥
          location.reload();
        } else if (accounts[0] !== userAccount) {
          // ç”¨æˆ·åˆ‡æ¢äº†è´¦æˆ·
          location.reload();
        }
      }

      // å¤„ç†ç½‘ç»œå˜åŒ–
      function handleChainChanged() {
        location.reload();
      }
    </script>
  </body>
</html>
