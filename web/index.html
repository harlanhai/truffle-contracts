<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SayHi DApp - 区块链打招呼应用</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .wallet-section {
        text-align: center;
        margin-bottom: 30px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .input-group {
        margin: 20px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #4a5568;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
      }

      .status.success {
        background-color: #c6f6d5;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      .status.error {
        background-color: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
      }

      .status.info {
        background-color: #bee3f8;
        color: #2a4365;
        border: 1px solid #63b3ed;
      }

      .hidden {
        display: none;
      }

      .message-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }

      .message-header {
        font-weight: bold;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .message-content {
        color: #2d3748;
        margin-bottom: 8px;
      }

      .message-meta {
        font-size: 12px;
        color: #718096;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .btn.connected {
        background: linear-gradient(45deg, #48bb78, #38a169);
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin: 20px 0;
      }

      .stat-item {
        flex: 1;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #718096;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🌟 SayHi DApp</h1>

      <!-- 钱包连接区域 -->
      <div class="card">
        <div class="wallet-section">
          <div id="walletStatus" class="status info">检查MetaMask状态中...</div>
          <button id="connectWallet" class="btn">连接 MetaMask</button>
          <button id="debugBtn" class="btn" style="background: #718096">调试信息</button>
          <div id="accountInfo" class="hidden">
            <p><strong>当前账户:</strong> <span id="currentAccount"></span></p>
            <p><strong>余额:</strong> <span id="accountBalance"></span> ETH</p>
            <p><strong>网络:</strong> <span id="networkInfo"></span></p>
          </div>
          <div id="debugInfo" class="debug-info hidden">
            <h4>调试信息:</h4>
            <div id="debugLog">等待调试信息...</div>
          </div>
        </div>
      </div>

      <!-- 合约统计信息 -->
      <div class="card">
        <h3>📊 合约统计</h3>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number" id="totalMessages">0</div>
            <div class="stat-label">总消息数</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="contractBalance">0</div>
            <div class="stat-label">合约余额 (ETH)</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="myMessages">0</div>
            <div class="stat-label">我的消息数</div>
          </div>
        </div>
        <button id="refreshStats" class="btn">刷新统计</button>
      </div>

      <!-- 发送消息区域 -->
      <div class="card">
        <h3>💬 发送消息</h3>
        <div class="input-group">
          <label for="messageInput">消息内容:</label>
          <textarea id="messageInput" rows="3" placeholder="输入你的消息..."></textarea>
        </div>
        <div class="input-group">
          <label for="ethAmount">转账金额 (ETH, 可选):</label>
          <input type="number" id="ethAmount" step="0.001" min="0" placeholder="0.01" />
        </div>
        <button id="sendMessage" class="btn">发送消息 + 转账</button>
        <!-- <button id="callSayHi" class="btn" style="background: #38a169">直接调用 sayHi</button>
        <button id="testContract" class="btn" style="background: #ed8936">测试合约连接</button>
        <button id="checkDeployment" class="btn" style="background: #9f7aea">检查合约部署</button> -->
        <div id="sendStatus"></div>
      </div>

      <!-- 查询消息区域 -->
      <!-- <div class="card">
        <h3>🔍 查询消息</h3>
        <button id="getLatestMessage" class="btn">获取最新消息</button>
        <div class="input-group">
          <label for="messageIndex">消息索引:</label>
          <input type="number" id="messageIndex" min="0" placeholder="0" />
          <button id="getMessageByIndex" class="btn">按索引查询</button>
        </div>
        <div id="queryStatus"></div>
      </div> -->

      <!-- 消息显示区域 -->
      <div class="card">
        <h3>📝 消息列表</h3>
        <button id="loadAllMessages" class="btn">加载所有消息</button>
        <div id="messagesList"></div>
      </div>
    </div>

    <script>
      // 合约配置
      const CONTRACT_ADDRESS = '0x61aa7C18cBB9D3d9A7FcB017BeC2D05B2255F2fa';
      let CONTRACT_ABI = null; // 将从JSON文件加载

      // 全局变量
      let provider;
      let signer;
      let contract;
      let userAccount;

      // 加载合约ABI
      async function loadContractABI() {
        try {
          console.log('正在加载合约ABI...');
          const response = await fetch('./FirstContract.json');

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contractJson = await response.json();
          CONTRACT_ABI = contractJson.abi;

          console.log('ABI加载成功:', CONTRACT_ABI);
          return true;
        } catch (error) {
          console.error('加载ABI失败:', error);

          // 如果加载失败，使用备用ABI
          console.log('使用备用ABI...');
          CONTRACT_ABI = [
            {
              inputs: [{ internalType: 'string', name: '_message', type: 'string' }],
              name: 'sayHi',
              outputs: [],
              stateMutability: 'payable',
              type: 'function',
            },
            {
              inputs: [{ internalType: 'uint256', name: '_index', type: 'uint256' }],
              name: 'getMessage',
              outputs: [
                { internalType: 'address', name: 'sender', type: 'address' },
                { internalType: 'string', name: 'content', type: 'string' },
                { internalType: 'uint256', name: 'timestamp', type: 'uint256' },
                { internalType: 'uint256', name: 'amount', type: 'uint256' },
              ],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getLatestMessage',
              outputs: [
                { internalType: 'address', name: 'sender', type: 'address' },
                { internalType: 'string', name: 'content', type: 'string' },
                { internalType: 'uint256', name: 'timestamp', type: 'uint256' },
                { internalType: 'uint256', name: 'amount', type: 'uint256' },
              ],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getTotalMessages',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [{ internalType: 'address', name: '_sender', type: 'address' }],
              name: 'getSenderMessageCount',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [],
              name: 'getContractBalance',
              outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
          ];

          showStatus('walletStatus', 'info', 'ABI加载失败，使用备用ABI。请确保FirstContract.json文件在同一目录下。');
          return false;
        }
      }

      // 初始化
      $(document).ready(async function () {
        console.log('页面加载完成');

        // 首先加载ABI
        const abiLoaded = await loadContractABI();

        if (abiLoaded) {
          showStatus('walletStatus', 'success', 'ABI加载成功，请连接MetaMask钱包');
        }

        checkMetaMaskInstallation();
        setupEventListeners();
        checkExistingConnection();
      });

      // 检查是否已经连接
      async function checkExistingConnection() {
        if (typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              console.log('检测到已连接的账户:', accounts[0]);
              // 自动连接
              await connectWallet();
            }
          } catch (error) {
            console.log('检查现有连接时出错:', error);
          }
        }
      }

      // 检查MetaMask是否安装
      function checkMetaMaskInstallation() {
        console.log('检查MetaMask安装状态...');
        if (typeof window.ethereum !== 'undefined') {
          console.log('MetaMask已安装');
          provider = new ethers.BrowserProvider(window.ethereum);
          showStatus('walletStatus', 'info', '请连接您的MetaMask钱包');
        } else {
          console.log('MetaMask未安装');
          showStatus('walletStatus', 'error', '请安装 MetaMask 钱包! 访问: https://metamask.io');
          $('#connectWallet').prop('disabled', true);
        }
      }

      // 设置事件监听器
      function setupEventListeners() {
        $('#connectWallet').click(connectWallet);
        $('#debugBtn').click(toggleDebugInfo);
        $('#sendMessage').click(sendMessage);
        // $('#callSayHi').click(callSayHiFunction);
        $('#testContract').click(testContract);
        $('#checkDeployment').click(checkContractDeployment);
        $('#getLatestMessage').click(getLatestMessage);
        $('#getMessageByIndex').click(getMessageByIndex);
        $('#refreshStats').click(refreshStats);
        $('#loadAllMessages').click(loadAllMessages);

        // 监听账户变化
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', handleAccountsChanged);
          window.ethereum.on('chainChanged', handleChainChanged);
        }
      }

      // 测试合约连接
      async function testContract() {
        if (!contract) {
          showStatus('sendStatus', 'error', '请先连接钱包');
          return;
        }

        try {
          showStatus('sendStatus', 'info', '正在测试合约连接...');

          // 首先检查合约地址是否有代码
          const code = await provider.getCode(CONTRACT_ADDRESS);
          console.log('合约代码长度:', code.length);

          if (code === '0x' || code.length <= 2) {
            showStatus(
              'sendStatus',
              'error',
              `合约地址 ${CONTRACT_ADDRESS} 上没有部署代码！<br>
                        请检查：<br>
                        1. 合约地址是否正确<br>
                        2. 是否连接到正确的网络<br>
                        3. 合约是否已正确部署`
            );
            return;
          }

          console.log('合约代码存在，长度:', code.length);

          // 测试基本的view函数
          console.log('测试 getTotalMessages...');
          const totalMessages = await contract.getTotalMessages();
          console.log('总消息数:', totalMessages.toString());

          console.log('测试 getContractBalance...');
          const contractBalance = await contract.getContractBalance();
          console.log('合约余额:', ethers.formatEther(contractBalance));

          showStatus(
            'sendStatus',
            'success',
            `合约连接成功！<br>
                    合约代码长度: ${code.length} bytes<br>
                    总消息数: ${totalMessages.toString()}<br>
                    合约余额: ${ethers.formatEther(contractBalance)} ETH`
          );
        } catch (error) {
          console.error('合约测试失败:', error);

          let errorMessage = '合约测试失败: ';

          if (error.code === 'BAD_DATA') {
            errorMessage += '数据解码失败，可能原因：<br>1. 合约ABI不匹配<br>2. 函数名称错误<br>3. 合约版本不一致';
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage += '合约调用异常，可能是函数不存在或参数错误';
          } else {
            errorMessage += error.message;
          }

          showStatus('sendStatus', 'error', errorMessage);
        }
      }

      // 新增：检查合约部署状态
      async function checkContractDeployment() {
        if (!provider) {
          showStatus('sendStatus', 'error', '请先连接钱包');
          return;
        }

        try {
          showStatus('sendStatus', 'info', '正在检查合约部署状态...');

          const code = await provider.getCode(CONTRACT_ADDRESS);
          const network = await provider.getNetwork();

          let status = `
                    <strong>网络信息:</strong><br>
                    - 名称: ${network.name}<br>
                    - Chain ID: ${network.chainId}<br>
                    - 合约地址: ${CONTRACT_ADDRESS}<br>
                    - 合约代码: ${code === '0x' ? '❌ 未部署' : '✅ 已部署 (' + code.length + ' bytes)'}<br>
                `;

          if (code === '0x') {
            status += `<br><strong>❌ 合约未部署到当前网络！</strong><br>
                    请检查：<br>
                    1. 合约地址是否正确<br>
                    2. 是否连接到正确的网络<br>
                    3. 合约是否已在当前网络部署`;
            showStatus('sendStatus', 'error', status);
          } else {
            status += `<br><strong>✅ 合约已正确部署</strong>`;
            showStatus('sendStatus', 'success', status);
          }
        } catch (error) {
          console.error('检查合约部署失败:', error);
          showStatus('sendStatus', 'error', '检查失败: ' + error.message);
        }
      }

      // 切换调试信息显示
      async function toggleDebugInfo() {
        const debugDiv = $('#debugInfo');
        debugDiv.toggleClass('hidden');

        if (!debugDiv.hasClass('hidden')) {
          await updateDebugInfo();
        }
      }

      // 更新调试信息
      async function updateDebugInfo() {
        const debugLog = $('#debugLog');
        let info = `
                <strong>时间:</strong> ${new Date().toLocaleString()}<br>
                <strong>ABI状态:</strong> ${CONTRACT_ABI ? '已加载' : '未加载'}<br>
                <strong>MetaMask状态:</strong> ${typeof window.ethereum !== 'undefined' ? '已安装' : '未安装'}<br>
                <strong>Provider:</strong> ${provider ? '已初始化' : '未初始化'}<br>
                <strong>Signer:</strong> ${signer ? '已获取' : '未获取'}<br>
                <strong>Contract:</strong> ${contract ? '已连接' : '未连接'}<br>
                <strong>用户账户:</strong> ${userAccount || '未连接'}<br>
                <strong>合约地址:</strong> ${CONTRACT_ADDRESS}<br>
            `;

        if (window.ethereum) {
          info += `<strong>Ethereum对象:</strong> 存在<br>`;
          info += `<strong>是否为MetaMask:</strong> ${window.ethereum.isMetaMask ? '是' : '否'}<br>`;
        }

        if (provider) {
          try {
            const network = await provider.getNetwork();
            info += `<strong>当前网络:</strong> ${network.name} (Chain ID: ${network.chainId})<br>`;

            // 检查合约代码
            const code = await provider.getCode(CONTRACT_ADDRESS);
            info += `<strong>合约代码:</strong> ${code === '0x' ? '❌ 未部署' : '✅ 已部署 (' + code.length + ' bytes)'}<br>`;
          } catch (e) {
            info += `<strong>网络获取失败:</strong> ${e.message}<br>`;
          }
        }

        if (contract && provider) {
          try {
            // 检查合约代码是否存在
            const code = await provider.getCode(CONTRACT_ADDRESS);
            if (code !== '0x') {
              // 测试合约连接
              const totalMessages = await contract.getTotalMessages();
              info += `<strong>合约测试:</strong> ✅ 成功 (总消息数: ${totalMessages.toString()})<br>`;
            } else {
              info += `<strong>合约测试:</strong> ❌ 合约未部署<br>`;
            }
          } catch (e) {
            info += `<strong>合约测试失败:</strong> ${e.message}<br>`;
          }
        }

        if (CONTRACT_ABI) {
          info += `<strong>ABI函数数量:</strong> ${CONTRACT_ABI.filter((item) => item.type === 'function').length}<br>`;
        }

        debugLog.html(info);
      }

      // 连接钱包
      async function connectWallet() {
        try {
          console.log('开始连接钱包...');
          showStatus('walletStatus', 'info', '正在连接钱包...');

          // 检查ABI是否已加载
          if (!CONTRACT_ABI) {
            showStatus('walletStatus', 'error', '合约ABI未加载，请刷新页面重试');
            return;
          }

          // 检查MetaMask是否可用
          if (typeof window.ethereum === 'undefined') {
            throw new Error('MetaMask未安装');
          }

          // 请求连接账户
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          });

          console.log('获取到的账户:', accounts);

          if (accounts.length === 0) {
            throw new Error('未获取到账户');
          }

          userAccount = accounts[0];
          console.log('当前用户账户:', userAccount);

          // 重新初始化provider和signer
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          console.log('合约初始化完成');

          // 获取并显示网络信息
          const network = await provider.getNetwork();
          $('#networkInfo').text(`${network.name} (Chain ID: ${network.chainId})`);

          // 显示账户信息
          $('#currentAccount').text(userAccount);
          const balance = await provider.getBalance(userAccount);
          $('#accountBalance').text(parseFloat(ethers.formatEther(balance)).toFixed(4));

          // 更新UI
          $('#accountInfo').removeClass('hidden');
          $('#connectWallet').text('已连接').prop('disabled', true).addClass('connected');
          showStatus('walletStatus', 'success', '钱包连接成功!');

          console.log('UI更新完成');

          // 刷新统计信息
          await refreshStats();
        } catch (error) {
          console.error('连接钱包失败:', error);
          showStatus('walletStatus', 'error', '连接钱包失败: ' + error.message);

          // 重置UI状态
          $('#accountInfo').addClass('hidden');
          $('#connectWallet').text('连接 MetaMask').prop('disabled', false);
        }
      }

      // 发送消息
      async function sendMessage() {
        if (!contract) {
          showStatus('sendStatus', 'error', '请先连接钱包');
          return;
        }

        const message = $('#messageInput').val().trim();
        if (!message) {
          showStatus('sendStatus', 'error', '请输入消息内容');
          return;
        }

        try {
          showStatus('sendStatus', 'info', '正在发送消息...');
          console.log('准备发送消息:', message);

          const ethAmount = $('#ethAmount').val() || '0';
          console.log('转账金额:', ethAmount, 'ETH');

          // 估算gas费用
          let gasEstimate;
          try {
            if (parseFloat(ethAmount) > 0) {
              gasEstimate = await contract.sayHi.estimateGas(message, {
                value: ethers.parseEther(ethAmount),
              });
            } else {
              gasEstimate = await contract.sayHi.estimateGas(message);
            }
            console.log('估算gas费用:', gasEstimate.toString());
          } catch (gasError) {
            console.error('Gas估算失败:', gasError);
            showStatus('sendStatus', 'error', 'Gas估算失败，请检查网络连接和合约地址');
            return;
          }

          // 准备交易选项
          const options = {
            gasLimit: (gasEstimate * 120n) / 100n, // 增加20%的gas限制
          };

          if (parseFloat(ethAmount) > 0) {
            options.value = ethers.parseEther(ethAmount);
          }

          console.log('交易选项:', options);

          // 发送交易
          const tx = await contract.sayHi(message, options);
          console.log('交易已提交:', tx.hash);
          showStatus('sendStatus', 'info', `交易已提交，正在等待确认...<br>交易哈希: ${tx.hash}`);

          // 等待交易确认
          const receipt = await tx.wait();
          console.log('交易已确认:', receipt);

          if (receipt.status === 1) {
            showStatus('sendStatus', 'success', `消息发送成功！<br>交易哈希: ${tx.hash}<br>Gas使用: ${receipt.gasUsed.toString()}`);

            // 清空输入框
            $('#messageInput').val('');
            $('#ethAmount').val('');

            // 刷新统计信息
            await refreshStats();
          } else {
            showStatus('sendStatus', 'error', '交易失败');
          }
        } catch (error) {
          console.error('发送消息失败:', error);

          let errorMessage = '发送失败: ';
          if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage += '余额不足';
          } else if (error.code === 'USER_REJECTED') {
            errorMessage += '用户取消了交易';
          } else if (error.message.includes('execution reverted')) {
            errorMessage += '合约执行失败，请检查输入参数';
          } else {
            errorMessage += error.message;
          }

          showStatus('sendStatus', 'error', errorMessage);
        }
      }

      // 获取最新消息
      async function getLatestMessage() {
        if (!contract) {
          showStatus('queryStatus', 'error', '请先连接钱包');
          return;
        }

        try {
          showStatus('queryStatus', 'info', '正在查询最新消息...');

          const result = await contract.getLatestMessage();
          displayMessage(result, '最新消息');
          showStatus('queryStatus', 'success', '查询成功!');
        } catch (error) {
          console.error('查询失败:', error);
          showStatus('queryStatus', 'error', '查询失败: ' + error.message);
        }
      }

      // 按索引获取消息
      async function getMessageByIndex() {
        if (!contract) {
          showStatus('queryStatus', 'error', '请先连接钱包');
          return;
        }

        const index = $('#messageIndex').val();
        if (index === '') {
          showStatus('queryStatus', 'error', '请输入消息索引');
          return;
        }

        try {
          showStatus('queryStatus', 'info', '正在查询消息...');

          const result = await contract.getMessage(index);
          displayMessage(result, `消息 #${index}`);
          showStatus('queryStatus', 'success', '查询成功!');
        } catch (error) {
          console.error('查询失败:', error);
          showStatus('queryStatus', 'error', '查询失败: ' + error.message);
        }
      }

      // 刷新统计信息
      async function refreshStats() {
        if (!contract) return;

        try {
          const totalMessages = await contract.getTotalMessages();
          $('#totalMessages').text(totalMessages.toString());

          const contractBalance = await contract.getContractBalance();
          $('#contractBalance').text(ethers.formatEther(contractBalance));

          if (userAccount) {
            const myMessages = await contract.getSenderMessageCount(userAccount);
            $('#myMessages').text(myMessages.toString());
          }
        } catch (error) {
          console.error('刷新统计失败:', error);
        }
      }

      // 加载所有消息
      async function loadAllMessages() {
        if (!contract) {
          alert('请先连接钱包');
          return;
        }

        try {
          const totalMessages = await contract.getTotalMessages();
          console.log('总消息数:', totalMessages.toString());
          const total = parseInt(totalMessages.toString());

          if (total === 0) {
            $('#messagesList').html('<p>暂无消息</p>');
            return;
          }

          $('#messagesList').html('<p>正在加载消息...</p>');
          let messagesHtml = '';

          // 倒序显示消息（最新的在前面）
          for (let i = total - 1; i >= 0; i--) {
            try {
              const result = await contract.getMessage(i);
              messagesHtml += formatMessageHtml(result, i);
            } catch (error) {
              console.error(`获取消息 ${i} 失败:`, error);
            }
          }

          $('#messagesList').html(messagesHtml || '<p>加载消息失败</p>');
        } catch (error) {
          console.error('加载消息失败:', error);
          $('#messagesList').html('<p>加载消息失败: ' + error.message + '</p>');
        }
      }

      // 显示单个消息
      function displayMessage(result, title) {
        const messageHtml = `
                <div class="message-item">
                    <div class="message-header">${title}</div>
                    <div class="message-content">"${result[1]}"</div>
                    <div class="message-meta">
                        发送者: ${result[0]}<br>
                        转账金额: ${ethers.formatEther(result[3])} ETH<br>
                        时间: ${new Date(Number(result[2]) * 1000).toLocaleString()}
                    </div>
                </div>
            `;
        $('#queryStatus').after(messageHtml);
      }

      // 格式化消息HTML
      function formatMessageHtml(result, index) {
        return `
                <div class="message-item">
                    <div class="message-header">消息 #${index}</div>
                    <div class="message-content">"${result[1]}"</div>
                    <div class="message-meta">
                        发送者: ${result[0]}<br>
                        转账金额: ${ethers.formatEther(result[3])} ETH<br>
                        时间: ${new Date(Number(result[2]) * 1000).toLocaleString()}
                    </div>
                </div>
            `;
      }

      // 显示状态信息
      function showStatus(elementId, type, message) {
        $(`#${elementId}`).removeClass('success error info').addClass(type).text(message);
      }

      // 处理账户变化
      function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
          // 用户断开了连接
          location.reload();
        } else if (accounts[0] !== userAccount) {
          // 用户切换了账户
          location.reload();
        }
      }

      // 处理网络变化
      function handleChainChanged() {
        location.reload();
      }
    </script>
  </body>
</html>
